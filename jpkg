#!/usr/bin/env python
# -*- coding: utf-8 -*-

from __future__ import print_function

import sys
import os
import argparse
from subprocess import check_output
from string import Template
from glob import glob

# for python2 compatibility
try:
    input = raw_input
except:
    pass

"""
This installation script installs the same version of anaconda2 and anaconda3 distributions.

Anaconda2 is built with Python 2
Anaconda3 is build with Python 3

We set up the jupyter notebook configurations to enable either python 2 or 3
kernels to be used regardless of which anaconda distribution was used to launch
the jupyter notebook server.

We also add our custom jupyter hub code to the jupyter configs.  All our configuration changes
and extensions are added to the anaconda subdirectory.

The tricky part is that anaconda installs its own extensions which we do not want.  It also
manages its own kernels which assume you use its virtual environments.  We do not.
So we uninstall the jupyter conda extensions and then reenable our extensions.

"""


def install_packages(cname, nopy2):
    global dirname

    pname = os.path.join(dirname, "configs", cname)
    print("Installing Packages for Python3 from %s" % (cname))

    with open(pname) as fp:
        for line in fp:
            if line[0] == '+':
                continue
            if line[0] == '#':
                if line.startswith('# PYTHON2') and nopy2 is True:
                    return
                # comment
                continue
            if line[0] == '!':
                line = line[1:].strip()
                print("Running:", line)
                os.system(line)
                continue
            sline = line.split()
            channel = None
            if len(sline) == 0:
                continue
            if sline[-1] == '--no-deps':
                sline = sline[:-1]
                nodeps = '--no-deps'
            else:
                nodeps = ''

            if len(sline) == 3:
                pkg, ver, inst = sline
            elif len(sline) == 4:
                pkg, ver, inst, channel = sline
            else:
                if len(sline) > 0:
                    print("Cannot parse line:", line)
                continue

            print("\n************** Installing %s %s" % (pkg, ver))
            if inst == 'conda':
                cmd = "conda install -y %s=%s %s" % (pkg, ver, nodeps)
                if channel:
                    cmd += " -c defaults -c %s" % channel
            elif inst == 'pip':
                if ver == '*':
                    cmd = "pip install -U --upgrade-strategy only-if-needed %s" % pkg
                else:
                    cmd = "pip install -U --upgrade-strategy only-if-needed %s==%s" % (pkg, ver)
            print("Running '%s'" % cmd)
            if os.system(cmd):
                print("ERROR: Installation of %s failed.\n" % pkg)
        print('\n')


def install_file(fname, destdir):
    "Run the anaconda install file"

    os.system('bash ' + fname + ' -b -p ' + destdir)

    bindir = os.path.join(destdir, 'bin')

    # set PATH so we can use 'conda'  and 'pip'
    path = os.environ['PATH']
    os.environ['PATH'] = bindir + ':' + path


def check_perm(p):
    """In each installation directory, check the permissions of files so
    we don't end up with packages users can't read."""
    cwd = os.getcwd()

    os.chdir(p)

    print("Checking file permissions in", p)
    bindir = os.path.join(p, 'bin')

    print("Finding and fixing files that are not world-readable")
    os.system('find . ! -perm -004 -exec chmod a+r {} \;')

    print("Finding non-searchable directories.  Should be none.")
    os.system('find . -type d -a ! -perm -011')

    print('Finding and fixing world-writable files.')
    os.system('find -L . -perm -o+w -exec chmod o-w {} \;')

    os.chdir(cwd)


def install_updates(cname, p, nopy2):
    global dirname

    # install packages we want
    install_packages(cname, nopy2)

    bindir = os.path.join(p, 'bin')

    # start_jupyter script
    os.system('cp %s %s' % (os.path.join(dirname, 'start_jupyter'), bindir))
    os.system('cp %s %s' % (os.path.join(dirname, 'start_jupyterlab'), bindir))



def install_R_pkgs(p):
    global dirname

    # install packages we want
    scriptname = os.path.join(dirname, 'inst.R')
    os.system('Rscript %s' % scriptname)


def install_kernels(p, nopy2):
    os.system('python -m ipykernel install --name "python3" --prefix=%s --display-name "Python3"' % p)
    if nopy2:
        return
    os.system('source activate Python2')
    os.system('python -m ipykernel install --name "python2" --prefix=%s --display-name "Python2"' % p)
    os.system('source deactivate Python2')

def install_octave(p, env_dir, desktop):
    "Install octave kernel, if octave is found"
    octave_kstr = find_octave(p, desktop, env_dir, prompt=False)
    if octave_kstr is not None:
        dname = os.path.join(p, 'share', 'jupyter', 'kernels', 'octave')
        if not os.path.exists(dname):
            os.mkdir(dname)
        fname = os.path.join(dname, 'kernel.json')
        with open(fname, 'w') as f:
            f.write(octave_kstr)


def write_env(rver, env_dir, pathlist):
    # write environ files for 'use' on the hubs
    for p in pathlist:
        bindir = os.path.join(p, 'bin')
        os.system('mkdir -p %s' % env_dir)

        fname = os.path.join(env_dir, os.path.basename(p))
        with open(fname, 'w') as f:
            f.write('\nconflict ANACONDA_CHOICE\n\n')
            f.write('desc "Anaconda is a package manager, an environment manager, a Python distribution, and a collection of over 1,000+ open source packages."\n\n')
            f.write('help "https://docs.anaconda.com/new-anaconda-start-here"\n\n')
            f.write('version=%s\n\n' % rver)
            f.write('prepend PATH %s\n\n' % bindir)
            f.write('tags MATHSCI\n')

        # needed for submit, which only works on python 2 for now
        if len(pathlist) > 1 and p == pathlist[1]:
            hubzero = '/usr/lib/python2.7/dist-packages/hubzero'
            libdir = os.path.join(p, 'lib', 'python2.7', 'site-packages')
            os.system('ln -s %s %s' % (hubzero, libdir))


def install_extensions(p, desktop):
    global dirname
    cwd = os.getcwd()
    os.chdir(dirname)
    os.chdir('nbextensions')

    with open('jupyter_notebook_config.py', 'r') as f:
        intro = f.read()

    spath = os.path.join(p, 'share', 'jupyter')
    os.system('mkdir -p ' + os.path.join(p, 'etc', 'jupyter'))
    fname = os.path.join(p, 'etc', 'jupyter', 'jupyter_notebook_config.py')
    with open(fname, 'w') as f:
        f.write(intro)
        # f.write("c.Application.log_level = 'DEBUG'\n")
        f.write("c.IPKernelApp.pylab = 'inline'\n")  # always put plots inline
        f.write("import sys\n")
        f.write("sys.path.append('%s')\n" % os.path.join(spath, 'nbextensions'))
        f.write("\n")
        f.write("c.NotebookApp.extra_template_paths = ['%s']\n" % os.path.join(spath, 'templates'))
        f.write("c.NotebookApp.extra_static_paths = ['%s']\n" % os.path.join(spath, 'static'))
        f.write("c.NotebookApp.trust_xheaders = True\n")
        f.write("c.NotebookApp.mathjax_url = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.3/MathJax.js'\n")
        if not desktop:
            f.write("c.NotebookApp.login_handler_class = 'hublogin.HubLoginHandler'\n")
        f.write("c.NotebookApp.disable_check_xsrf = True")


    if not desktop:
        os.system('jupyter nbextension install --sys-prefix prefs')

    # install calysto document tools
    os.system('jupyter nbextension install --sys-prefix https://github.com/Calysto/notebook-extensions/archive/master.zip')


    # install hublogin and terminate
    dst = os.path.join(p, 'share', 'jupyter')
    ext = os.path.join(dst, 'nbextensions')
    # os.system('cp terminate.py %s' % ext)
    if not desktop:
        os.system('cp hublogin.py %s' % ext)

    # patch dashboards to work with our tool mode and autorun extensions
    # dashdir = os.path.join(ext, 'jupyter_dashboards', 'notebook', 'dashboard-view')
    # os.system('patch -f -d %s < dashboard-actions.patch' % dashdir)

    # install logos
    os.system('mkdir -p ' + dst + '/static')
    os.system('cp -r ../logo/* ' + dst + '/static')
    os.chdir(cwd)


def cleanup(p, desktop):
    # final cleanup

    # remove any local extensions because they may conflict with global
    os.system('rm -rf ~/.local/share/jupyter/nbextensions')

    # uninstall anaconda jupyter notebook extensions which we don't want
    #os.system('conda uninstall -y nb_conda')

    # Enable the extensions.
    # Must do this after uninstalling the conda extensions because they
    # will uninstall our extensions too!  These just update etc/jupyter/nbconfig/notebook.json
    #os.system('jupyter nbextension enable --sys-prefix autorun/main 2> /dev/null')
    if not desktop:
        os.system('jupyter nbextension enable --sys-prefix prefs/prefs')
    #os.system('jupyter nbextension enable --sys-prefix dragdrop/main')
    # os.system('jupyter nbextension enable --py --sys-prefix widgetsnbextension')
    # os.system('jupyter nbextension enable --py --sys-prefix gmaps')
    # os.system('jupyter serverextension enable --py declarativewidgets --sys-prefix')
    # os.system('jupyter nbextension enable --py --sys-prefix declarativewidgets')
    #os.system('jupyter nbextension enable --py jupyter_dashboards --sys-prefix')

    # disable nbdime extension
    # os.system('jupyter nbextension uninstall nbdime')

    # maybe someday we will enable nbpresent, but right now it is much too buggy
    # os.system('jupyter nbextension enable --sys-prefix  nbpresent/js/nbpresent.min 2> /dev/null')

    # os.system('jupyter nbextension enable --sys-prefix  --py pythreejs')
    # os.system('jupyter nbextension enable --sys-prefix  --py nglview')
    # if p == pathlist[0]:
    #    # python2 only
    #    os.system('jupyter nbextension enable --sys-prefix  --py nbmolviz')

    # mailboxes. only on nanohub right now
    # if socket.gethostname() == 'nanoHUB':
        # os.system('jupyter nbextension enable --sys-prefix sendto/sendto')

    #os.system('conda clean -y --all')


def get_versions(cname):
    global dirname
    env_dir = ""

    cname = os.path.join(dirname, 'configs', cname)
    with open(cname) as fp:
        for line in fp:
            if line[0] == '#':
                # comment
                continue
            sline = line.split()
            if len(sline) != 2:
                continue
            if sline[0] == '+DESKTOP':
                desk = sline[1] == 'True'
            elif sline[0] == '+VERSION':
                ver = sline[1]
            elif sline[0] == '+RVERSION':
                rver = sline[1]
            elif sline[0] == '+ENVIRON_CONFIG_DIR':
                env_dir = sline[1]
            elif sline[0] == '++':
                return (ver, rver, env_dir, desk)


def make_new(args):
    ver, rver, env_dir, desktop = get_versions(args.name)

    script = "Anaconda3-%s-Linux-x86_64.sh" % ver
    instpath = os.path.realpath('anaconda3-%s' % (rver))
    if not os.path.isfile(script):
        print("Downloading", script)
        os.system("curl -O https://repo.continuum.io/archive/%s" % script)
        if not os.path.isfile(script):
            print("Error: %s not found and could not download." % script)
            sys.exit(1)

    print("Installing Anaconda3-%s in %s" % (ver, instpath))
    install_file(script, instpath)

    if not desktop:
        write_env(rver, env_dir, instpath)

    do_install(desktop, args.name, env_dir, instpath, args.nopy2)


def do_downloads(ver):
    ret = os.system("wget http://packages.hubzero.org/blobs/anaconda3-%s.tar.xz -O - | tar -xJ" % ver)

    if ret:
        print("Download failed.")
        sys.exit(1)


def make_netinst(args):
    do_downloads(args.ver)

    instpath = os.path.realpath('anaconda3-%s' % (args.ver))

    # write env modules
    env_dir = '/apps/share64/debian7/environ.d'
    write_env(args.ver, env_dir, pathlist)

    if args.nopy2:
        # remove python2 kernel from menu
        kpath = "/apps/share64/debian7/anaconda/anaconda3-%s/share/jupyter/kernels/python2" % args.ver
        os.system("mv %s/kernel.json %s/kernel.json.disabled" % (kpath, kpath))

    try:
        check_output("octave --version", shell=True)
        octave = True
    except:
        octave = False
    if octave is False:
        print("Could not find octave.  Disabling octave kernel in menu.")
        kpath = "/apps/share64/debian7/anaconda/anaconda3-%s/share/jupyter/kernels/octave" % args.ver
        os.system("mv %s/kernel.json %s/kernel.json.disabled" % (kpath, kpath))

    hostimage = os.uname()[1].lower() + '.png'
    imagedir = "/apps/share64/debian7/anaconda/anaconda3-%s/share/jupyter/static" % args.ver
    hifull = os.path.join(imagedir, hostimage)
    hzfull = os.path.join(imagedir, 'hubzero.png')
    if not os.path.isfile(hifull):
        print("WARNING:")
        print("This installation will put an image representing your host in the Jupyter menubar.")
        print("No image for your host, \"%s\" could be found." % os.uname()[1].lower())
        print("This installation process will use a default hubzero image instead.")
        print("To update the image, copy a PNG image of your choice to")
        print(hifull)
        print()
        os.system('cp %s %s' % (hzfull, hifull))

def do_install(desktop, cname, env_dir, instpath, nopy2):
    install_updates(cname, instpath, nopy2)
    install_kernels(instpath, nopy2)
    install_octave(instpath, env_dir, desktop)
    install_R_pkgs(instpath)
    install_extensions(instpath, desktop)
    check_perm(instpath)
    cleanup(instpath, desktop)


def make_cleanup(args):
    instpath = os.path.realpath('anaconda3-%s' % (args.ver))
    check_perm(instpath)


def find_octave(pypath, desktop, env_dir, prompt=True):
    global dirname

    pypath += "/bin/python"

    if desktop:
        try:
            oc = check_output("octave --version", shell=True).split('\n')[0]
            ver = oc.split()[-1]
            opath = check_output("which octave", shell=True).strip()
        except:
            if prompt:
                print("\nWARNING: Octave not found.  You may want to install it.")
                inp = ''
                while inp == '':
                    inp = input('Continue without installing Octave kernel? [Y/N]')
                if inp.upper() != 'Y':
                    sys.exit(0)
            return None

        kernel = open(os.path.join(dirname, 'octave_kernel_desktop')).read()
        s = Template(kernel)
        d = dict(python=pypath,
                 ver="Octave %s" % ver,
                 exe=opath)
        return s.substitute(d)

    try:
        olist = check_output("ls %s/octave*" % env_dir, shell=True).split()
    except:
        if prompt:
            print("\nWARNING: No octave module was found.")
            inp = ''
            while inp == '':
                inp = input('Continue without installing Octave kernel? [Y/N]')
            if inp.upper() != 'Y':
                sys.exit(0)
        return None

    with open(olist[-1]) as f:
        for line in f:
            if line.startswith('prepend PATH'):
                opath = line.split()[-1]
                ver = opath.split('-')[-1].split('/')[0]
                break

    kernel = open(os.path.join(dirname, 'octave_kernel')).read()
    s = Template(kernel)
    d = dict(python=pypath,
             ver="Octave %s" % ver,
             exe=opath + '/octave',
             home=os.path.dirname(opath))
    return s.substitute(d)


if __name__ == '__main__':
    global dirname
    dirname = os.path.dirname(os.path.realpath(sys.argv[0]))

    # at least one install fails if this is not set
    os.environ['LANG'] = 'en_US.UTF-8'

    parser = argparse.ArgumentParser(
            usage="""jpkg <command> [<args>]

Commands are:
   install {configname}    New install using the config file in config/configname.

   netinst {version}       Network install a specific version of anaconda from hubzero.

   cleanup [version]       Fix any permissions problems.  Run after manually updating installation.

Packages will be installed in the current directory in
subdirectories anaconda[2|3]-{version}.

To add new packages, add them to the config file
then run the update command.
""")

    parser.add_argument('--nopy2', dest='nopy2', action='store_true',
                        default=False,
                        help='Do not install Python2 (default: False)')

    subparsers = parser.add_subparsers()

    # create the parser for the "install" command
    parser_install = subparsers.add_parser('install')
    parser_install.add_argument('name', type=str)
    parser_install.set_defaults(func=make_new)

    # create the parser for the "update" command
    parser_up = subparsers.add_parser('netinst')
    parser_up.add_argument('ver', type=str)
    parser_up.set_defaults(func=make_netinst)

    # create the parser for the "fix" command
    parser_fix = subparsers.add_parser('cleanup')
    parser_fix.add_argument('ver', default='',  nargs='?', type=str)
    parser_fix.set_defaults(func=make_cleanup)

    args = parser.parse_args()
    args.func(args)

    # jpkg install nano41
    # jpkg install nano41-dev
    # jpkg install hubzero41
    # jpkg netinst 5.1
    # jpkg cleanup [5.1]

